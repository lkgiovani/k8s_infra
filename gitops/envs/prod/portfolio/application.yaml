---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  annotations:
    argocd-image-updater.argoproj.io/image-list: portfolio=lghcr.io/lkgiovani/lkgiovani-portfolio
    argocd-image-updater.argoproj.io/portfolio.update-strategy: semver
    argocd-image-updater.argoproj.io/write-back-method: git
  finalizers:
    - resources-finalizer.argocd.argoproj.io/background
  name: portfolio-app-prod
  namespace: argocd
spec:
  destination:
    namespace: prod
    server: https://kubernetes.default.svc

  project: default
  source:
    helm:
      valuesObject:
        #Deployment
        image:
          repository: ghcr.io/lkgiovani/lkgiovani-portfolio
          tag: "v1.0.0"
        service:
          port: 3000
        livenessProbe:
          httpGet:
            path: /
            port: http
          initialDelaySeconds: 10
          periodSeconds: 15
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /
            port: http
          initialDelaySeconds: 5
          periodSeconds: 10
          failureThreshold: 3

        #Autoscaling
        autoscaling:
          enabled: true
          maxReplicas: 2

        #Ingress
        ingress:
          enabled: true
          className: traefik
          annotations:
            cert-manager.io/cluster-issuer: cloudflare-clusterissuer
          hosts:
            - host: todinho.lkgiovani.com
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - secretName: traefik-cert-secret
              hosts:
                - todinho.lkgiovani.com
    path: gitops/helm/portfolio
    repoURL: https://github.com/lkgiovani/k8s_infra.git
    targetRevision: main

  syncPolicy:
    automated:
      allowEmpty: false
      prune: true
      selfHeal: true
    syncOptions:
      - Validate=true
      - CreateNamespace=true
      - PrunePropagationPolicy=foreground
      - PruneLast=true
